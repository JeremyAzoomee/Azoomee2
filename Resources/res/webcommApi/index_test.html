<html>
	<head>
		<title>Game storage API</title>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>
	<body bgcolor="black">
		<div id="loadingPage">
			<div id="loadingArea">
				<img src="./circle_1.png" id="circle1">
				<img src="./circle_1.png" id="circle2">
				<img src="./load.png" id="loadingText">
			</div>
		</div>
		<script>
			function addFrameWithUrl(url)
			{
				var iframe = document.createElement('iframe');
				iframe.src = url;
				iframe.id = "contentFrame";
				iframe.width  = window.innerWidth - 10;
    			iframe.height = window.innerHeight - 10;
    			iframe.style.border = "none";
				document.body.appendChild(iframe);

				iframe.addEventListener("load", removeLoadingScreen);

				window.addEventListener("message", receiveMessage, false);
			}

			function removeLoadingScreen()
			{
				var target = document.getElementById("loadingPage");
				target.parentElement.removeChild(target);
			}

			function receiveMessage(event)
			{
				//Check if the game is communicating with the webapi standard

				if ('method' in event.data)
				{
					if('score' in event.data)
					{
						console.log("[API] it also has score value: " + event.data.score);
						var frames = window.frames;
						frames[0].postMessage("{method: 'method'}", "*");
					}
					else
					{
						console.log("[API] message received! method: " + event.data.method + " responseid: " + event.data.responseID);
						var frames = window.frames;
						frames[0].postMessage("{method: 'method'}", "*");
					}

					return;
				}

				if(event.data == "saveImage")
				{
					var title = localStorage.getItem("artname");
					var data = localStorage.getItem("art");

					if(title == "NEW")
					{
						title = Date.now() + ".imag";
						localStorage["artname"] = title;
					}

					if(data == "NEW") return;

					window.location.href = "saveimage://writeDataToFile?title?"+ title + "?data?" + data;

					return;
				}
				else
				{
					for(var i = 0; i < localStorage.length; i++)
					{
						var title = localStorage.key(i);
						var data = localStorage.getItem(localStorage.key(i));
						window.location.href = "senddata://writeDataToFile?title?"+ title + "?data?" + data;
					}
    				return;
    			}
			}

      function clearLocalStorage()
      {
          localStorage.clear();
      }

      function addDataToLocalStorage(key, data)
			{
					localStorage[key] = data;
			}

			function getUrlVars()
			{
				var vars = {};
				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value)
				{
					vars[key] = value;
				});
				return vars;
			}

			addFrameWithUrl("examplegame.html");
			//addFrameWithUrl(getUrlVars()["contentUrl"]); //for automated testing
		</script>
	</body>
</html>
