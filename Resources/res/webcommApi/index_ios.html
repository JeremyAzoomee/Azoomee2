<html>
	<head>
		<title>Game storage API</title>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>
	<body bgcolor="black">
		<div id="loadingPage">
			<div id="loadingArea">
				<img src="./circle_1.png" id="circle1">
				<img src="./circle_1.png" id="circle2">
				<img src="./load.png" id="loadingText">
			</div>
		</div>
		<script>
			function addFrameWithUrl(url)
			{
				var iframe = document.createElement('iframe');
				iframe.src = url;
				iframe.width  = window.innerWidth - 15;
    			iframe.height = window.innerHeight - 15;
    			iframe.scrolling = "no";
    			iframe.style.border = "none";
				document.body.appendChild(iframe);

				iframe.addEventListener("load", removeLoadingScreen);

				window.addEventListener("message", receiveMessage, false);
			}

			function removeLoadingScreen()
			{
				var target = document.getElementById("loadingPage");
				target.parentElement.removeChild(target);
			}

			function receiveMessage(event)
			{
				//Check if the game is communicating with the webapi standard

				if ('method' in event.data)
				{
					if('score' in event.data)
					{
						window.location.href = "apirequest://apiscoreupdate?method?"+ event.data.method + "?responseID?" + event.data.responseID + "?score?" + event.data.score;
					}
					else if('imageData' in event.data)
					{
						window.location.href = "apirequest://apiimagesave?method?"+ event.data.method + "?responseID?" + event.data.responseID + "?imageData?" + event.data.imageData;
					}
					else if('logString' in event.data)
					{
						window.location.href = "apirequest://apilog?method?"+ event.data.method + "?responseID?" + event.data.responseID + "?logString?" + event.data.logString;
					}
					else
					{
						window.location.href = "apirequest://apirequest?method?"+ event.data.method + "?responseID?" + event.data.responseID + "?score?null";
					}

					return;
				}
			}

      function clearLocalStorage()
      {
      	localStorage.clear();
      }

      function addDataToLocalStorage(data)
			{
				dataString = atob(data);
				if(dataString == "") return;

				var allRecords = dataString.split("|");

				for(var i = 0; i < allRecords.length; i++)
				{
					var currentRecord = allRecords[i].split("!");

					var currentKey = currentRecord[0];
					var currentValue = currentRecord[1];

					localStorage[currentKey] = currentValue;
				}
			}

			function saveLocalDataBeforeExit()
			{
				var stringToSave = "";
				for(var i = 0; i < localStorage.length; i++)
				{
					if((localStorage.key(i) != "")&&(localStorage.getItem(localStorage.key(i)) != ""))
					{
						if(stringToSave.length > 0) stringToSave += "|";
						stringToSave += localStorage.key(i) + "!" + localStorage.getItem(localStorage.key(i));
					}
				}

				return stringToSave;
			}

			function answerMessageReceivedFromAPI(answerString)
			{
				answerString = atob(answerString);
				var toSend = JSON.parse(answerString);
				window.frames[0].postMessage(toSend, "*");
			}
		</script>
	</body>
</html>
