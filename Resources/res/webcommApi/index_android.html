<html>
	<head>
		<title>Game storage API - android</title>
	</head>
	<body>
		<script>
			function getUrlVars() 
			{
				var vars = {};
				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) 
				{
					vars[key] = value;
				});
				return vars;
			}
			
			function receiveMessage(event)
			{
				if(event.data == "saveImage")
				{
					var title = localStorage.getItem("artname");
					var data = localStorage.getItem("art");
					
					if(title == "NEW") 
					{
						title = Date.now() + ".imag";
						localStorage["artname"] = title;
					}
					
					if(data == "NEW") return;
					
					console.log("File save process: " + title);
					
					NativeInterface.saveImage(title, data);
				}
				else
				{			
  					for(var i = 0; i < localStorage.length; i++)
  					{
  						var title = localStorage.key(i);
  						var data = localStorage.getItem(localStorage.key(i));
  						NativeInterface.saveData(title, data);
  					}
  				}
  				
    			return;
			}
			
			function addDataToLocalStorage(key, data)
			{
				localStorage[key] = data;
				console.log("Data added!");
				console.log(key);
				console.log(data);
			}
			
			//Read all local data from Android
			localStorage.clear();
			
			console.log("now we are starting the passive loading process");
			console.log(NativeInterface.getAmountOfStorageElements());
			
			for(var i = 0; i < NativeInterface.getAmountOfStorageElements(); i++)
			{
				console.log("getting key: " + i);
				var key = NativeInterface.getKeyForStorageElement(i);
				console.log("key got: " + key);
				
				if(key != "DIR")
				{
					console.log("getting value: " + i);
					var data = NativeInterface.getValueForStorageElement(i);
					addDataToLocalStorage(key, data);
				} 
			}
			
			console.log("Here is all localStorage data before starting:");
			
			for(var i = 0; i < localStorage.length; i++)
			{
				var title = localStorage.key(i);
  				var data = localStorage.getItem(localStorage.key(i));
				console.log(title + " - " + data);
			}
			
			//creating iframe
			
			var contentUrl = getUrlVars()["contentUrl"];
			var iframe = document.createElement('iframe');
			iframe.src = contentUrl;
			iframe.width  = window.innerWidth - 50;
    		iframe.height = window.innerHeight - 50;
			document.body.appendChild(iframe);
		
			window.addEventListener("message", receiveMessage, false);
		</script>
	</body>
</html>